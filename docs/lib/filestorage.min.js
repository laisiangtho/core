/*!
    fileStorage -- Javascript file Storage
    Version 1.0.3-2017.04.08
    https://scriptive.github.io/fileStorage
*/
!function(os,win){"use strict";var app={setting:{readAs:["readAsText","readAsArrayBuffer","readAsDataURL","readAsBinaryString","createObjectURL"],extension:{mp3:{ContentType:"audio/mp3"},mp4:{ContentType:"audio/mp4"},txt:{ContentType:"text/plain"},css:{ContentType:"text/css"},avi:{ContentType:"video/x-msvideo"},html:{ContentType:"text/html"},mxml:{ContentType:"application/xv+xml"},rss:{ContentType:"application/rss+xml"},xml:{ContentType:"application/xml"},js:{ContentType:"application/javascript"},json:{ContentType:"application/json"},xhtml:{ContentType:"application/xhtml+xml"},pdf:{ContentType:"application/pdf"},jpg:{ContentType:"image/jpeg"},jpeg:{ContentType:"image/jpeg"},png:{ContentType:"image/png"},other:{ContentType:"text/plain",Charset:"UTF-8",fileName:"Uknown",fileExtension:""}}},config:{Base:"storage",RequestQuota:1073741824,support:[],objectStore:{name:os,version:1,store:{file:"file"}}},message:{RequestFileSystem:"requestFileSystem API supported!",IndexedDBAPI:"No requestFileSystem API but IndexedDB will be used to store!",NoRequestFileSystem:"No requestFileSystem API!",NoURLProvided:"no URL provided",NoFileFound:"no File found",Fail:"Fail",UnknownError:"Unknown Error",PleaseSeeStatus:"Please see {status}!"},userCallback:{before:function(){},progress:function(){}},mergeObject:function(to){for(var s,a=arguments,b=Object(to),o=1;o<a.length;o++)if(a[o].constructor===Object)for(var i in a[o])try{s?b.hasOwnProperty(i)?b[i].constructor===Array?b[i]=this.mergeArray(b[i],a[o][i]):b[i].constructor===Object&&(b[i]=this.mergeObject(b[i],a[o][i])):b[i]=a[o][i]:b[i].constructor===Array?b[i]=this.mergeArray(b[i],a[o][i]):b[i].constructor===Object?b[i]=this.mergeObject(b[i],a[o][i]):b[i]=a[o][i]}catch(e){b[i]=a[o][i]}else 1===o&&(s=a[o]);return b},mergeArray:function(b){for(var b,a=arguments,o=1;o<a.length;o++)a[o].constructor===Array&&(b=b.concat(a[o]).filter(function(item,index,b){return b.indexOf(item)===index}));return b},hasCallback:function(a,b){return"object"==typeof a&&"function"==typeof a[b]},hasCallbackMethod:function(a,b){return this.hasCallback(a,b)?a[b]:new Function},createBlob:function(Query){Query.blob||(Query.data?Query.dataType||(Query.blob=new Blob([Query.data],{type:Query.fileType})):Query.blob=new Blob([Query.fileContent],{type:Query.fileType}))},readBlob:function(a,b){return new Promise(function(resolve,reject){try{var file=new FileReader;switch(file.onabort=function(e){reject(e)},file.onerror=function(e){reject(e)},file.onload=function(e){resolve(file.result)},b){case"readAsDataURL":file.readAsDataURL(a);break;case"readAsText":file.readAsText(a);break;case"readAsArrayBuffer":file.readAsArrayBuffer(a);break;case"readAsBinaryString":file.readAsBinaryString(a);break;default:resolve(window.URL.createObjectURL(a)),window.URL.revokeObjectURL()}}catch(e){reject(e)}})},afterDownload:function(Query){return Query.data.constructor!==Blob?Query.blob=new Blob([Query.data.constructor===Object?JSON.stringify(Query.data,null,2):Query.data],{type:Query.fileType}):Query.blob=Query.data,new Promise(function(resolve,reject){app.readBlob(Query.blob,Query.readAs).then(function(e){Query.fileContent=e,resolve(Query)},function(e){reject(e)})})},dirChecker:function(dir){return!!dir&&dir.split("/").slice(0,-1)},dirCreator:function(root,dir,callback){"."!=dir[0]&&""!=dir[0]||(dir=folders.slice(1)),root.getDirectory(dir[0],{create:!0},function(dirEntry){dir.length?app.dirCreator(dirEntry,dir.slice(1),callback):callback(!0)},function(e){callback(!1,e)})},fileWriter:function(fileEntry,blob){return new Promise(function(resolve,reject){fileEntry.createWriter(function(fileWriter){fileWriter.onwriteend=function(e){this.onwriteend=null,this.truncate(this.position),resolve(e)},fileWriter.onerror=function(e){reject(e)},fileWriter.write(blob)},function(e){reject(e)})})},fileCreator:function(){},fileReader:function(){},fileRemover:function(){},initiate:{start:function(done,error){return app.database.start().then(function(e){return e},function(){return!1}).then(function(database){app.initiate.Chrome(done,function(){app.initiate.Cordova(done,function(e){database?(app.config.message=app.message.IndexedDBAPI,done(database)):error(e)})})})},Chrome:function(done,error){try{navigator.webkitPersistentStorage.requestQuota(app.config.RequestQuota,function(grantedBytes){app.config.ResponseQuota=grantedBytes,win.requestfileStorage=win.webkitRequestFileSystem,win.resolvefileStorage=win.webkitResolveLocalFileSystemURL,win.requestfileStorage(app.config.Permission>0?win.PERSISTENT:win.TEMPORARY,grantedBytes,function(e){app.config.support.push("storage"),Object.defineProperty(app.user,"storage",{enumerable:!1,value:e.root}),done(e)},function(e){error(e)})},function(e){error(e)})}catch(e){error(e)}},Cordova:function(done,error){try{win.requestfileStorage=win.requestFileSystem||win.webkitRequestFileSystem,win.resolvefileStorage=win.resolveLocalFileSystemURL||win.webkitResolveLocalFileSystemURL,win.requestfileStorage?(win.LocalFileSystem&&(win.PERSISTENT=win.LocalFileSystem.PERSISTENT,win.TEMPORARY=win.LocalFileSystem.TEMPORARY),win.requestfileStorage(app.config.Permission>0?win.PERSISTENT:win.TEMPORARY,app.config.RequestQuota,function(e){app.config.support.push("storage"),Object.defineProperty(app.user,"storage",{enumerable:!1,value:e.root}),done(e)},function(e){error(e)})):error(app.message.NoRequestFileSystem)}catch(e){error(e)}}},database:{start:function(){return new Promise(function(resolve,reject){app.config.objectStore?app.database.IndexedDB().then(function(e){resolve(e)},function(e){reject(e)}):app.database.localStorage().then(function(e){resolve(e)},function(e){reject(e)})})},IndexedDB:function(){return new Promise(function(resolve,reject){Object.defineProperty(app.user,"db",{enumerable:!1,value:win.indexedDB||win.mozIndexedDB||win.webkitIndexedDB||win.msIndexedDB});try{var db=app.user.db.open(app.config.objectStore.name,app.config.objectStore.version);db.onerror=function(){reject(this.error)},db.onupgradeneeded=function(){var o=app.config.objectStore.store;if("object"==typeof o)for(var i in o)if(o.hasOwnProperty(i)){var store=o[i];if("object"==typeof store&&store.hasOwnProperty("name")){var storeName=store.name;this.result.objectStoreNames.contains(storeName)||("object"==typeof store.option?this.result.createObjectStore(storeName,store.option):this.result.createObjectStore(storeName))}else"string"==typeof store&&(this.result.objectStoreNames.contains(store)||this.result.createObjectStore(store))}},db.onsuccess=function(e){var o=app.config.objectStore.store.file;"object"==typeof o&&o.hasOwnProperty("name")&&(app.config.objectStore.store.file=o.name),app.config.support.push("database"),Object.defineProperty(app.user,"database",{enumerable:!1,value:e.target.result}),resolve(this.result)}}catch(e){reject(e)}})},localStorage:function(){return new Promise(function(resolve,reject){try{Object.defineProperty(app.user,"db",{enumerable:!1,value:win.localStorage}),resolve()}catch(e){reject(e)}})}},open:function(a,b){return app.openRequest(a,b)},openRequest:function(a,b){return a&&"object"==typeof a&&this.mergeObject(this.config,a),this.ready.constructor===Function?this.ready(b):this.user},ready:function(response){return this.ready=new Promise(function(resolve,reject){app.initiate.start(function(e){-1==app.config.support.indexOf(app.config.Base)&&(app.config.Base=app.config.support[0]),Object.defineProperties(app.user,{file:{enumerable:!1,value:app.file[app.config.Base]}}),app.config.message||(app.config.message=app.message.RequestFileSystem),resolve(app.user[app.config.Base])},function(e){"string"==typeof e?app.config.message=e:e.message?(app.config.message=e.message,e.name&&(app.config.name=e.name),e.code&&(app.config.status=e.code)):(app.config.status=e,app.config.message=app.message.PleaseSeeStatus),reject(app.config)})}).then(function(e){app.hasCallbackMethod(response,"success").call(app.user,e)},function(e){app.hasCallbackMethod(response,"fail")(e)}).then(function(){return app.hasCallbackMethod(response,"done").call(app.user,app.config),app.user}),this.user},file:{storage:{save:function(Query){return new Promise(function(resolve,reject){try{app.createBlob(Query),app.user.storage.getFile(Query.urlLocal,{create:!0},function(fileEntry){app.fileWriter(fileEntry,Query.blob).then(function(e){resolve(e)},function(e){reject(e)})},function(e){var isBecauseDir=app.dirChecker(Query.urlLocal);isBecauseDir.length?app.dirCreator(app.user.storage,isBecauseDir,function(status,msg){status?app.user.storage.getFile(Query.urlLocal,{create:!0},function(fileEntry){app.fileWriter(fileEntry,Query.blob).then(function(e){resolve(e)},function(e){reject(e)})},function(e){reject(e)}):reject(msg)}):reject(e)})}catch(e){reject(e)}})},open:function(Query){return new Promise(function(resolve,reject){app.user.storage.getFile(Query.urlLocal,{create:!1},function(fileEntry){fileEntry.file(function(file){app.readBlob(file,Query.readAs).then(function(e){Query.fileSize=file.size,Query.fileExtension=file.name.split(".").pop(),file.type?Query.fileType=file.type:Query.fileExtension&&app.setting.extension[Query.fileExtension]&&(Query.fileType=app.setting.extension[Query.fileExtension].ContentType),Query.fileContent=e,resolve(Query)},function(e){reject(e)})},function(file){reject(file)})},function(e){reject(e)})})},delete:function(Query){return new Promise(function(resolve,reject){app.user.storage.getFile(Query.urlLocal,{create:!1},function(fileEntry){fileEntry.remove(function(e){resolve()},function(e){reject(e)})},function(e){Query.fileNotFound?resolve():reject(e)})})},name:"storage"},database:{save:function(Query){return new Promise(function(resolve,reject){try{var storeTable=app.config.objectStore.store.file,objectTransaction=app.user.database.transaction([storeTable],"readwrite"),objectStore=objectTransaction.objectStore(storeTable);app.createBlob(Query),objectTransaction.oncomplete=function(e){resolve(e)},objectTransaction.onerror=function(e){reject(e)},objectStore.put(Query.blob,Query.urlLocal)}catch(e){reject(e)}})},open:function(Query){return new Promise(function(resolve,reject){try{var storeTable=app.config.objectStore.store.file,objectTransaction=app.user.database.transaction([storeTable],"readwrite"),objectStore=objectTransaction.objectStore(storeTable),storeOpenCursor=objectStore.openCursor(Query.urlLocal);storeOpenCursor.onerror=function(e){reject(e)},storeOpenCursor.onsuccess=function(e){var cursor=this.result;cursor?app.readBlob(cursor.value,Query.readAs).then(function(e){Query.fileContent=e,Query.fileSize=cursor.value.size,Query.fileExtension=Query.urlLocal.split(".").pop(),cursor.value.type?Query.fileType=cursor.value.type:Query.fileExtension&&app.setting.extension[Query.fileExtension]&&(Query.fileType=app.setting.extension[Query.fileExtension].ContentType),resolve(Query)},function(e){reject(e)}):reject({message:app.message.NoFileFound})}}catch(e){reject(e)}})},delete:function(Query){return new Promise(function(resolve,reject){try{var storeTable=app.config.objectStore.store.file,objectTransaction=app.user.database.transaction([storeTable],"readwrite"),objectStoreDelete=objectTransaction.objectStore(storeTable).delete(Query.urlLocal);objectStoreDelete.onerror=function(e){reject(e)},objectStoreDelete.onsuccess=function(e){resolve(e)}}catch(e){reject(e)}})},name:"database"}},user:{download:function(Query){return app.ready.then(function(user){return new Promise(function(resolve,reject){var xhr=win.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),Percentage=0;xhr.addEventListener("progress",function(e){Percentage++,app.hasCallback(Query,"progress")&&(e.lengthComputable?(Percentage=Math.floor(e.loaded/e.total*100),Query.progress(Percentage)):xhr.readyState==XMLHttpRequest.DONE?Query.progress(100):200!=xhr.status?(Query.progress(Math.floor(Percentage/7*100)),Percentage++):Query.progress(100))},!1),xhr.addEventListener("load",function(e){if(Query.urlResponse=xhr.responseURL,Query.fileName=Query.url.replace(/[\#\?].*$/,"").substring(Query.url.lastIndexOf("/")+1),Query.fileExtension=Query.fileName.split(".").pop(),Query.urlLocal)if(!0===Query.urlLocal){var fileUrlLocalTmp=Query.url.match(/\/\/[^\/]+\/([^\.]+)/);Query.urlLocal=fileUrlLocalTmp?fileUrlLocalTmp[1].replace(/[\#\?].*$/,""):Query.url.replace(/[\#\?].*$/,"")}else Query.urlLocal=Query.urlLocal.replace(/[\#\?].*$/,"");else Query.urlLocal=Query.fileName;Query.fileCharset="UTF-8",Query.fileSize=e.total,Query.data=xhr.response,app.setting.extension[Query.fileExtension]&&(Query.fileType=app.setting.extension[Query.fileExtension].ContentType),xhr.responseType?(Query.dataType=xhr.responseType,Query.fileType=xhr.response.type?xhr.response.type:Query.fileType):(xhr.responseXML&&(Query.fileCharset=xhr.responseXML.charset,Query.fileType=xhr.responseXML.contentType,Query.xml=xhr.responseXML),Query.fileContent=xhr.responseText),200==xhr.status?(delete Query.before,delete Query.progress,app.afterDownload(Query).then(function(){"object"==typeof Query.fileOption&&!0===Query.fileOption.create&&Query.urlLocal&&app.config.support.length?user.file.save(Query).then(function(e){Query.fileCreation=!0,Query.api=e,resolve(Query)},function(e){reject(e)}):resolve(Query)},function(e){reject(e)})):reject(xhr.statusText?{message:xhr.statusText+": "+Query.url,code:xhr.status}:xhr.status?{message:app.message.Fail,code:xhr.status}:{message:app.message.UnknownError})},!1),xhr.addEventListener("error",function(e){reject(e)},!1),xhr.addEventListener("abort",function(e){reject(e)},!1),Query.requestCache?Query.urlRequest=Query.url+(Query.url.indexOf("?")>0?"&":"?")+"_="+(new Date).getTime():Query.urlRequest=Query.url,Query.url?(xhr.open(Query.requestMethod?Query.requestMethod:"GET",Query.urlRequest,!0),app.hasCallbackMethod(Query,"before")(xhr),xhr.send()):reject({message:app.message.NoURLProvided})})})},save:function(Query){return app.ready.then(function(user){return user.file.save(Query)})},open:function(Query){return app.ready.then(function(user){return user.file.open(Query)})},delete:function(Query){return app.ready.then(function(user){return user.file.delete(Query)})},browse:function(Query){return app.ready.then(function(user){})}}};win[os]=app.open}("fileStorage",window);